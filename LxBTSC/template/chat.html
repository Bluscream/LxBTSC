<!DOCTYPE HTML>
<html>
    <head>
        <meta charset='utf-8'>
        <meta name='viewport' content='width=device-width, initial-scale=1.0'>
        <link rel='stylesheet' type='text/css' href='style.css'/>
        <link rel='stylesheet' type'text/css' href='xbbcode.css'/>
        <!--<link rel='stylesheet' type='text/css' href='../../../styles/style.qss'/>-->

        <script type='text/javascript' src='jquery-3.2.1.min.js'></script>
        <script type='text/javascript' src='qwebchannel.js'></script>
        <script type='text/javascript' src='jquery.resize.js'></script>
        <script type='text/javascript' src='xbbcode.js'></script>
        <script type='text/javascript' src='Emotes.js'></script>

        <script type='text/javascript'>
            var main;
            var IsBottom = true;
            var QtObject;
            var stayDown = function() {
                if (IsBottom) {
                    window.scroll(0, document.body.scrollHeight);
                }
            };
            
        window.onload = function() {
            new QWebChannel(qt.webChannelTransport, function(channel) {
                QtObject = channel.objects.wObject;
            });
            main = $('#main');
            Emotes.emote_list_element = $('#emote-list');
            $.when(Emotes.load()).always(function(){
                Emotes.makeKeyList();
            });
            $('#main').resize(stayDown);
        };

        window.onscroll = function(ev) {
            if ((window.innerHeight + window.pageYOffset) >= document.body.offsetHeight) {
                IsBottom = true;
            }
            else {
                IsBottom = false;
            }
        };

        function AddServer(serverId) {
            if (!$(`.tab-${serverId}-server`).length) {
                main.append(`<div class='tab-${serverId}-server'></div><div class='tab-${serverId}-channel'></div>`);
            }
            ShowTarget(`tab-${serverId}-server`);
        }

        function ParseBBCode(line) {
            var result = XBBCODE.process({
                text: line
            });
            //console.error("err", result.error);
            //console.dir(result.errorQueue);
            return result.html.replace(/(?:\r\n|\r|\n)/g, '<br>');
        }

        function AddLine(target, direction, time, name, line) {
            CreateTabIfNotExist(target);

            if ($(`.${target}`).childElementCount > 500) {
                $(`.${target}`).firstElementChild.remove();
            }

            var p = $('<p/>', {
                class: 'TextMessage_Normal'
            }).html(
                `<span class='Body'>
                 <img class='${direction}'>
                 <span class='TextMessage_Time'><${time}> </span>
                 <span class='TextMessage_UserLink'>"${name}"</span>: 
                 <span class='TextMessage_Text'>${Emotes.emoticonize(ParseBBCode(line))}</span>
                 </span>`
            ).appendTo($(`.${target}`));
            
            Embed(p, line);

            if (IsBottom) {
                window.scroll(0, document.body.scrollHeight);
            }
        }

        function AddStatusLine(target, time, type, line) {
            CreateTabIfNotExist(target);

            if ($(`.${target}`).childElementCount > 500) {
                $(`.${target}`).firstElementChild.remove();
            }
            var formatted = `<p class='${type}'>
                                <img class='Incoming'>
                                <span class='TextMessage_Time'><${time}> </span>
                                <span class='TextMessage_Text'>${ParseBBCode(line)}</span>
                            </p>`;
            
            $(`.${target}`).append(formatted);

            if (IsBottom) {
                window.scroll(0, document.body.scrollHeight);
            }
        }

        function ShowTarget(target) {
            console.log("show: " + target);
            CreateTabIfNotExist(target);

            $('[class^="tab"]').hide();
            $(`.${target}`).show();
            window.scroll(0, document.body.scrollHeight);
        }

        function CreateTabIfNotExist(target) {
            if (!$(`.${target}`).length) {
                main.append(`<div class='${target}' style='display: none;'></div>`);
            }
        }

        function escapeRegExp(str) {
            return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
        }

        function Embed(element, line) {
            var embeds_div = $('<div/>', { class:'embeds'});

            var match;
            //var yt = /http(?:s?):\/\/(?:www\.)?youtu(?:be\.com\/watch\?v=|\.be\/)([\w-]*)(&(amp;)?[\w\?=]*)?/gi;
            var yt = /http(?:s?):\/\/(?:www\.)?youtu(?:be\.com\/watch\?v=|\.be\/)([-_A-Za-z0-9]{10}[AEIMQUYcgkosw048]*)(&(amp;)?[\w\?=]*)?/gi;
            while (match = yt.exec(line)) {
                var embed_video = $('<div/>', { class:'embed-video' })
                .html('<iframe frameborder="0" src="https://www.youtube.com/embed/'+ match[1] +'" width="400" height="225"></iframe>')
                .appendTo(embeds_div);
            }

            embeds_div.not(':empty').insertAfter(element);
        }

        function ShowOrHideMenu() {
            $("#popup").toggleClass('menu-visible');
        }

        function emoteClicked(key, shift) {
            QtObject.emoteClicked(key);
            if(!shift) {
                ShowOrHideMenu();
            }
        }
        
        </script>
    </head>
    <body id='main'>
        <div class='emote-menu' id='popup'>
            <div id='emote-list'></div>
        </div>
    </body>
</html>