<!DOCTYPE HTML>
<html>
    <head>
        <meta charset='utf-8'>
        <meta name='viewport' content='width=device-width, initial-scale=1.0'>
        <link rel='stylesheet' type='text/css' href='style/style.css'/>
        <link rel='stylesheet' type='text/css' href='style/xbbcode.css'/>

        <script type='text/javascript' src='js/jquery-3.2.1.min.js'></script>
        <script type='text/javascript' src='js/qwebchannel.js'></script>
        <script type='text/javascript' src='js/jquery.resize.js'></script>
        <script type='text/javascript' src='js/xbbcode.js'></script>
        <script type='text/javascript' src='js/Emotes.js'></script>

        <script type='text/javascript'>
            var main;
            var IsBottom = true;
            var QtObject;
            var stayDown = function() {
                if (IsBottom) {
                    window.scroll(0, document.body.scrollHeight);
                }
            };

            new QWebChannel(qt.webChannelTransport, function(channel) {
                QtObject = channel.objects.wObject;
                
                QtObject.toggleEmoteMenu.connect(ToggleEmoteMenu);
                QtObject.textMessageReceived.connect(AddLine);
                QtObject.statusMessageReceived.connect(AddStatusLine);
                QtObject.tabChanged.connect(ShowTarget);
                QtObject.addServer.connect(AddServer);
                QtObject.loadEmotes.connect(LoadEmotes);
            });
            
        window.onload = function() {
            main = $('#main');
            Emotes.emote_list_element = $('#emote-list');
            LoadEmotes();
            $('#main').resize(stayDown);
        };

        window.onscroll = function(ev) {
            if ((window.innerHeight + window.pageYOffset) >= document.body.offsetHeight) {
                IsBottom = true;
            }
            else {
                IsBottom = false;
            }
        };

        function AddServer(serverId) {
            if (!$(`.tab-${serverId}-server`).length) {
                main.append(`<div class='tab-${serverId}-server'></div><div class='tab-${serverId}-channel'></div>`);
            }
            ShowTarget(`tab-${serverId}-server`);
        }

        function ParseBBCode(line) {
            var result = XBBCODE.process({
                text: line
            });
            //console.error("err", result.error);
            //console.dir(result.errorQueue);
            return result.html.replace(/(?:\r\n|\r|\n)/g, '<br>');
        }

        function AddLine(target, direction, time, name, line) {
            CreateTabIfNotExist(target);

            if ($(`.${target}`).childElementCount > 500) {
                $(`.${target}`).firstElementChild.remove();
            }

            var p = $('<p/>', {
                class: 'TextMessage_Normal'
            }).html(
                `<span class='Body'>
                 <img class='${direction}'>
                 <span class='TextMessage_Time'><${time}> </span>
                 <span class='TextMessage_UserLink'>"${name}"</span>: 
                 <span class='TextMessage_Text'>${Emotes.emoticonize(ParseBBCode(line))}</span>
                 </span>`
            ).appendTo($(`.${target}`));
            
            Embed(p, line);

            if (IsBottom) {
                window.scroll(0, document.body.scrollHeight);
            }
        }

        function AddStatusLine(target, time, type, line) {
            CreateTabIfNotExist(target);

            if ($(`.${target}`).childElementCount > 500) {
                $(`.${target}`).firstElementChild.remove();
            }
            var formatted = `<p class='${type}'>
                                <img class='Incoming'>
                                <span class='TextMessage_Time'><${time}> </span>
                                <span class='TextMessage_Text'>${ParseBBCode(line)}</span>
                            </p>`;
            
            $(`.${target}`).append(formatted);

            if (IsBottom) {
                window.scroll(0, document.body.scrollHeight);
            }
        }

        function ShowTarget(target) {
            console.log("show: " + target);
            CreateTabIfNotExist(target);

            $('[class^="tab"]').hide();
            $(`.${target}`).show();
            window.scroll(0, document.body.scrollHeight);
        }

        function CreateTabIfNotExist(target) {
            if (!$(`.${target}`).length) {
                main.append(`<div class='${target}' style='display: none;'></div>`);
            }
        }

        function escapeRegExp(str) {
            return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
        }

        function Embed(element, line) {
            var embeds_div = $('<div/>', { class:'embeds'});
            var close_a = $('<a/>', { class:'close-embeds', href:'#_', title:'close', text:'x' })
            .click(function(e) {
                $(this).parent().remove();
            });

            var match;
            //var yt = /http(?:s?):\/\/(?:www\.)?youtu(?:be\.com\/watch\?v=|\.be\/)([\w-]*)(&(amp;)?[\w\?=]*)?/gi;
            var yt = /http(?:s?):\/\/(?:www\.)?youtu(?:be\.com\/watch\?v=|\.be\/)([-_A-Za-z0-9]{10}[AEIMQUYcgkosw048]*)(&(amp;)?[\w\?=]*)?/gi;
            while (match = yt.exec(line)) {
                console.log('Found youtube link:' + match[1])
                var embed_video = $('<div/>', { class:'embed-container' })
                .html('<iframe frameborder="0" src="https://www.youtube.com/embed/'+ match[1] +'" width="400" height="225"></iframe>')
                .wrap('<div/>').parent()
                .appendTo(embeds_div);
            }

            var img = /(https?:\/\/\S*?\.(?:png|jpe?g|gif|webp)(?:\?(?:(?:(?:[\w_-]+=[\w_-]+)(?:&[\w_-]+=[\w_-]+)*)|(?:[\w_-]+)))?)/gi;
            while (match = img.exec(line)) {
                console.log('Found image link:' + match[1])
                var embed_image = $('<div/>', { class:'embed-container' })
                .html('<a href="' + match[1] + '"><img src="' + match[1] + '"></a>')
                .wrap('<div/>').parent()
                .appendTo(embeds_div);
            }

            var audio = /(https?:\/\/\S*?\.(?:opus|ogg|oga|wav|wma|flac)(?:\?(?:(?:(?:[\w_-]+=[\w_-]+)(?:&[\w_-]+=[\w_-]+)*)|(?:[\w_-]+)))?)/gi;
            while (match = audio.exec(line)) {
                console.log('Found audio link:' + match[1])
                var embed_audio = $('<div/>', { class:'embed-container' })
                .html('<audio controls preload="metadata" src="' + match[1] + '">')
                .wrap('<div/>').parent()
                .appendTo(embeds_div);
            }

            var video = /(https?:\/\/\S*?\.(?:webm|ogv)(?:\?(?:(?:(?:[\w_-]+=[\w_-]+)(?:&[\w_-]+=[\w_-]+)*)|(?:[\w_-]+)))?)/gi;
            while (match = video.exec(line)) {
                console.log('Found video link:' + match[1])
                var embed_video = $('<div/>', { class:'embed-container' })
                .html('<video width="100%" height="100%" controls preload="metadata" src="' + match[1] + '" loop >')
                .wrap('<div/>').parent()
                .appendTo(embeds_div);
            }

            var paste = /https?:\/\/pastebin.com\/([0-9a-zA-Z]+)/gi;
            while (match = paste.exec(line)) {
                console.log('Found pastebin link:' + match[1])
                var embed_paste = $('<div/>', { class:'embed-container' })
                .html('<iframe src="https://pastebin.com/embed_iframe/' + match[1] + '" style="border:none;width:100%"></iframe>')
                .wrap('<div/>').parent()
                .appendTo(embeds_div);
            }

            var pornhub = /https?:\/\/(?:[a-z0-9]+[.])*pornhub[.]com\/view_video.php\?viewkey=([0-9a-z]+)/gi;
            while (match = pornhub.exec(line)) {
                console.log('Found pornhub link:' + match[1])
                var embed_paste = $('<div/>', { class:'embed-container' })
                .html('<iframe src="https://pornhub.com/embed/' + match[1] + '" style="border:none;width:100%" scrolling="no" allowfullscreen></iframe>')
                .wrap('<div/>').parent()
                .appendTo(embeds_div);
            }

            /*var gist = /https:\/\/gist\.github\.com\/[0-9a-zA-Z]+\/[0-9a-zA-Z]+/gi;
            while (match = gist.exec(line)) {
                var embed_paste = $('<div/>', { class:'embed-container' })
                .html('  NEEDS SOME KIND OF IFRAME HERE ')
                .wrap('<div/>').parent()
                .appendTo(embeds_div);
            }*/

            embeds_div.not(':empty').append(close_a).insertAfter(element);
        }

        function ToggleEmoteMenu() {
            $("#popup").toggleClass('menu-visible');
        }

        function emoteClicked(key, shift) {
            QtObject.emoteClicked(key);
            if(!shift) {
                ToggleEmoteMenu();
            }
        }

        function LoadEmotes() {
            Emotes.clear();
            Emotes.load();
        }
        </script>
    </head>
    <body id='main'>
        <div class='emote-menu' id='popup'>
            <div id='emote-list'></div>
        </div>
    </body>
</html>
